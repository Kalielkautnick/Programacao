---ESSE MERGE INTO FOI CRIADO PARA CORRIGIR A TABELA DE ESTOQUE, SETANDO A QUANTIDADE EM ESTOQUE
---IGUAL AO SALDO DE ENTRADAS E SAÍDAS DO PRODUTO, PORQUE O ESTOQUE DO CLIENTE ESTAVA TODO ERRADO E A ÚNICA TABELA QUE ESTAVA CORRETA
---ERA A TABELA DE MOVIMENTAÇÕES

MERGE INTO PA_ITEN_001 PA 
USING (
-----------------
SELECT CODIGO, COR, TAM, BARRA, TIPO, DEPOSITO, LOTE, LOCAL,QUANTIDADE_ESTOQUE, QTDE_MOV, DIFERENCA FROM (
SELECT PA.CODIGO, PA.COR, PA.TAM, PA.BARRA, PA.TIPO, PA.DEPOSITO, PA.LOTE, PA.LOCAL, PA.QUANTIDADE AS QUANTIDADE_ESTOQUE, 
SUM(CASE WHEN PAMOV.OPERACAO = 'E' THEN PAMOV.QTDE ELSE (PAMOV.QTDE * -1) END) AS QTDE_MOV, 
ABS((SUM(CASE WHEN PAMOV.OPERACAO = 'E' THEN PAMOV.QTDE ELSE (PAMOV.QTDE * -1) END) - PA.QUANTIDADE)) AS DIFERENCA
FROM PA_MOV_001 PAMOV
INNER JOIN PA_ITEN_001 PA
ON (PAMOV.CODIGO = PA.CODIGO AND PAMOV.COR = PA.COR AND PAMOV.TAMANHO = PA.TAM AND PAMOV.DEPOSITO = PA.DEPOSITO AND PAMOV.TIPO = PA.TIPO AND PAMOV.LOTE = PA.LOTE AND PAMOV.LOCAL = PA.LOCAL)
WHERE 1=1
GROUP BY PA.DEPOSITO, PA.CODIGO, PA.COR, PA.TAM, PA.BARRA, PA.TIPO, PA.LOTE, PA.LOCAL, PA.QUANTIDADE) TAB
WHERE 1=1
AND DIFERENCA <> 0
-----------------
) TAB
ON ((PA.CODIGO=TAB.CODIGO AND PA.COR=TAB.COR AND PA.TAM=TAB.TAM AND PA.DEPOSITO=TAB.DEPOSITO AND PA.LOTE=TAB.LOTE AND PA.LOCAL=TAB.LOCAL AND PA.TIPO=TAB.TIPO))
WHEN MATCHED THEN
UPDATE SET PA.QUANTIDADE = TAB.QTDE_MOV;
