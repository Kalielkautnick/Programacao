esse comando MERGE INTO corrige as comissÃµes nos itens do pedido, baseando-se na tabela GRUPO_COMISSAO_001 e as faixas de desconto

MERGE INTO PED_ITEN_001 ITEN
USING (
SELECT PED.NUMERO, PED.TAB_PRE, PED.CODIGO, PED.COR, PED.TAM, PED.PERC_DESCONTO, G.DE, G.ATE, PED.PERC_COMISSAO AS PERC_COM_ATUAL, G.COMISSAO AS PERC_COM_CORRETO, G.COM_PADRAO, G.SEQ FROM (
SELECT PED.NUMERO, PED.TAB_PRE, P.PERC_COMISSAO, P.CODIGO, P.COR, P.TAM,
ROUND(AVG(100 - (CAST(P.PRECO * 100 AS NUMERIC(18,2)) / P.PRECO_ORIG)),0) AS PERC_DESCONTO
FROM PEDIDO_001 PED 
INNER JOIN PED_ITEN_001 P 
ON (PED.NUMERO=P.NUMERO)
WHERE 1=1
AND P.PRECO_ORIG > 0
AND PED.NUMERO IN ('XXXXX') 
GROUP BY PED.NUMERO, PED.TAB_PRE, P.PERC_COMISSAO, P.CODIGO, P.COR, P.TAM) PED 
INNER JOIN GRUPO_COMISSAO_001 G ON (G.TAB_PRE=PED.TAB_PRE AND PED.PERC_DESCONTO BETWEEN G.DE AND G.ATE)
) COMISSAO
ON ((COMISSAO.NUMERO=ITEN.NUMERO AND COMISSAO.CODIGO=ITEN.CODIGO AND COMISSAO.COR=ITEN.COR AND COMISSAO.TAM=ITEN.TAM AND ITEN.PERC_COMISSAO <> COMISSAO.PERC_COM_CORRETO))
WHEN MATCHED THEN
UPDATE SET PERC_COMISSAO = COMISSAO.PERC_COM_CORRETO;
