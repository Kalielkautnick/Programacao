--- PRIMEIRO RODAR ESSE COMANDO PARA GERAR OS UPDATES E DELETES EM FAIXAS DUPLICADAS, MONTANDO UM DE-PARA AUTOMÁTICO.

WITH F AS (
SELECT FAIXA F, MIN(ID) ID, STRING_AGG(DISTINCT TAMANHO, '/' ORDER BY TAMANHO) LISTA FROM FAIXA_ITEN_001
GROUP BY FAIXA
),
F2 AS (
SELECT FAIXA F2, MIN(ID) ID, STRING_AGG(DISTINCT TAMANHO, '/' ORDER BY TAMANHO) LISTA FROM FAIXA_ITEN_001
GROUP BY FAIXA
)
SELECT DISTINCT 'UPDATE PRODUTO_001 SET FAIXA = ''' || F.F || ''' WHERE FAIXA = ''' || F2.F2 || ''';' FROM F 
INNER JOIN F2 ON (F2.LISTA=F.LISTA) WHERE F.F<>F2.F2 AND F.ID<F2.ID
UNION ALL 
SELECT DISTINCT 'DELETE FROM FAIXA_001 WHERE CODIGO = ''' || F2.F2 || ''';' FROM F 
INNER JOIN F2 ON (F2.LISTA=F.LISTA) WHERE F.F<>F2.F2 AND F.ID<F2.ID
UNION ALL 
SELECT DISTINCT 'DELETE FROM FAIXA_ITEN_001 WHERE FAIXA = ''' || F2.F2 || ''';' FROM F 
INNER JOIN F2 ON (F2.LISTA=F.LISTA) WHERE F.F<>F2.F2 AND F.ID<F2.ID
------------------------------------------

--- DEPOIS RODAR ESSE COMANDO PARA AJUSTAR O VÍNCULO ENTRE A FAIXA DE TAMANHO DO PRODUTO COM OS TAMANHOS DA GRADE.
=========== AJUSTAR FAIXA DE TAMANHO NA CAPA DO PRODUTO ===============
MERGE INTO PRODUTO_001 PRO
USING (
WITH PA AS (
SELECT CODIGO, STRING_AGG(DISTINCT TAM, '/' ORDER BY TAM) LISTA FROM PA_ITEN_001 PA
GROUP BY CODIGO),
FAIXA AS (
SELECT FAIXA, STRING_AGG(DISTINCT TAMANHO, '/' ORDER BY TAMANHO) LISTA FROM FAIXA_ITEN_001 PA
GROUP BY FAIXA)
SELECT PRO.ID, PRO.CODIGO, PRO.FAIXA FAIXA_ATUAL, PA.LISTA LISTA_TAM_PRODUTO, FAIXA.LISTA LISTA_TAM_FAIXA, MAX(FAIXA2.FAIXA) FAIXA_CERTA, MAX(FAIXA2.LISTA) LISTA_FAIXA_CERTA 
FROM PRODUTO_001 PRO 
INNER JOIN PA ON PRO.CODIGO=PA.CODIGO
LEFT JOIN FAIXA ON (PRO.FAIXA=FAIXA.FAIXA)
LEFT JOIN FAIXA FAIXA2 ON (FAIXA2.LISTA=PA.LISTA)
WHERE COALESCE(PA.LISTA, '') <> COALESCE(FAIXA.LISTA,'')
GROUP BY PRO.ID, PRO.CODIGO, PRO.FAIXA, PA.LISTA, FAIXA.LISTA
) TAB
ON ((PRO.ID=TAB.ID AND TAB.FAIXA_CERTA <> ''))
WHEN MATCHED THEN
UPDATE SET FAIXA = TAB.FAIXA_CERTA;
