//PARA RODAR ESSES COMANDOS, CERTIFIQUE-SE DE TER VERIFICADO O ARQUIVO: INSERT FAIXA_ITEN (constando na pasta: FAIXA DE TAMANHO).

MERGE INTO PRODUTO_001 PRO
USING (
SELECT TAB.CODIGO, MAX(PRO.ID_PRO) ID_PRO, MAX(PRO.FAIXA) FAIXA_ATUAL, MIN(TAB.FAIXA) FAIXA_CERTA FROM (
SELECT DISTINCT PA.CODIGO, PA.TAM, FAIXA.FAIXA FROM (
SELECT CODIGO, TAM, (SELECT COUNT(DISTINCT PI.TAM) FROM PA_ITEN_001 PI WHERE PI.CODIGO=PA.CODIGO) CONTADOR FROM PA_ITEN_001 PA
GROUP BY CODIGO, TAM) PA
INNER JOIN (
SELECT FX.FAIXA, FX.TAMANHO, FX.POSICAO, FX.CONTADOR FROM (
SELECT FAIXA, TAMANHO, POSICAO, (SELECT COUNT(DISTINCT FI.TAMANHO) FROM FAIXA_ITEN_001 FI WHERE FI.FAIXA=PA.FAIXA) CONTADOR FROM FAIXA_ITEN_001 PA
GROUP BY FAIXA, TAMANHO, POSICAO
ORDER BY FAIXA, POSICAO) FX
) FAIXA ON (FAIXA.TAMANHO=PA.TAM AND FAIXA.CONTADOR=PA.CONTADOR)
WHERE 1=1) TAB
INNER JOIN PRODUTO_001 PRO ON (TAB.CODIGO=PRO.CODIGO)
WHERE EXISTS (SELECT DISTINCT 1 FROM PA_ITEN_001 P WHERE P.CODIGO=TAB.CODIGO AND P.TAM=TAB.TAM)
AND NOT EXISTS (SELECT DISTINCT 1 FROM PA_ITEN_001 P WHERE P.CODIGO=TAB.CODIGO AND 
NOT EXISTS (SELECT DISTINCT 1 FROM FAIXA_ITEN_001 FI WHERE FI.FAIXA=TAB.FAIXA AND FI.TAMANHO=P.TAM)
)
AND PRO.FAIXA IS NULL
GROUP BY TAB.CODIGO) TAB
ON ((PRO.ID_PRO=TAB.ID_PRO))
WHEN MATCHED THEN
UPDATE SET FAIXA = TAB.FAIXA_CERTA;
