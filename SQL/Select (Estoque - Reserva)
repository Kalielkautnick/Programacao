--ESSE SELECT NÓS TIVEMOS QUE MONTAR PARA UM CLIENTE QUE TRABALHAVA DE UM JEITO ÚNICO, USAVAM UMA TABELA QUE ERA SÓ PARA ELES
--E NESSE SELECT, A GENTE CONSEGUIA FAZER A DISTINÇÃO DE QUAL DAS GRADES DO PRODUTO EXISTIA RESERVA, E ENTÃO, APRESENTAVA
--O SALDO DO ITEM POR GRADE.

SELECT PA.CODIGO, PA.COR, PA.TAM, PA.LOCAL, PA.LOTE, PA.QUANTIDADE, PA.TIPO, PA.DEPOSITO,

COALESCE((SELECT SUM(INF_PED_RESERVA.QTDE) FROM INF_PED_RESERVA INF_PED_RESERVA 
          INNER JOIN KIT_ITEM_001 KIT_ITEM ON (KIT_ITEM.CODIGO = INF_PED_RESERVA.CODIGO)
          (AND KIT_ITEM.COR = INF_PED_RESERVA.COR) AND (KIT_ITEM.TAM = INF_PED_RESERVA.TAM) AND (KIT_ITEM.ORDEM = INF_PED_RESERVA.ORDEM)
              WHERE INF_PED_RESERVA.CODIGO = PA.CODIGO AND INF_PED_RESERVA.COR = PA.COR AND INF_PED_RESERVA.TAM = PA.TAM 
              AND KIT_ITEM.NUMERO = PA.LOTE ),0) QTDE_INF_RES,

COALESCE((SELECT SUM(PED.QTDE) FROM PED_RESERVA_001 PED WHERE EXISTS(SELECT * FROM INF_PED_RESERVA RES 
          WHERE (RES.NUMERO=PED.NUMERO) AND (RES.CODIGO=PED.CODIGO) AND (RES.COR=PED.COR) AND (RES.TAM=PED.TAM) 
          AND (RES.RESERVA=PED.RESERVA) AND (RES.CODIGO = PA.CODIGO) AND (RES.COR = PA.COR) AND (RES.TAM = PA.TAM)
          AND (RES.CODIGO = PA.CODIGO) AND (RES.COR = PA.COR) AND (RES.TAM = PA.TAM))),0) QTDE_RESERVA,

PA.QUANTIDADE - COALESCE((SELECT SUM(INF_PED_RESERVA.QTDE) FROM INF_PED_RESERVA INF_PED_RESERVA 
                          INNER JOIN KIT_ITEM_001 KIT_ITEM ON (KIT_ITEM.CODIGO = INF_PED_RESERVA.CODIGO)
                          AND (KIT_ITEM.COR = INF_PED_RESERVA.COR) AND (KIT_ITEM.TAM = INF_PED_RESERVA.TAM)  
                          AND (KIT_ITEM.ORDEM = INF_PED_RESERVA.ORDEM)
                          WHERE (INF_PED_RESERVA.CODIGO = PA.CODIGO) AND (INF_PED_RESERVA.COR = PA.COR) 
                          AND (INF_PED_RESERVA.TAM = PA.TAM) AND (KIT_ITEM.NUMERO = PA.LOTE)),0) SALDO 
FROM PA_ITEN_001 PA  
LEFT JOIN PRODUTO_001 PRODUTO ON (PRODUTO.CODIGO = PA.CODIGO) 
LEFT JOIN CADCOR_001 COR ON (COR.COR = PA.COR) 
LEFT JOIN DEPOSITO_001 DEPOSITO ON (DEPOSITO.CODIGO  = PA.DEPOSITO) 
LEFT JOIN TABQUL_001 QUALIDADE  ON (QUALIDADE.CODIGO = PA.TIPO) 
WHERE PA.CODIGO = '150015C' 
AND PA.DEPOSITO IN ('0000')
AND PA.LOTE NOT IN ('000000') 
ORDER BY PA.CODIGO, PA.COR, PA.LOTE

