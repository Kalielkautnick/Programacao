--EU APRIMOREI ESSE SELECT PARA MOSTRAR TUDO SOBRE O PEDIDO, QUANTIDADE EM EXPEDIÇÃO, RESERVA, SALDO, 
---E AINDA RETORNA PEDIDOS QUE ESTAVAM COM SALDO NEGATIVO, OU SEJA, 
--ESTAVAM ERRADOS NO BANCO E PRECISÁVAMOS ARRUMAR.

SELECT NUMERO, CODIGO, COR, TAM, PED_QTDE, PED_FAT, RES_QTDE, RES_BAI, EXP_QTDE, EXP_FAT, SALDO FROM (
SELECT PEDIDO.NUMERO, PEDIDO.CODIGO, PEDIDO.COR, PEDIDO.TAM, PEDIDO.PED_QTDE, PEDIDO.PED_FAT, PEDIDO.RES_QTDE, PEDIDO.RES_BAI,
       PEDIDO.EXP_QTDE, PEDIDO.EXP_FAT, PEDIDO.SALDO FROM (
      SELECT  PED.NUMERO,
              ITEN.CODIGO,
              ITEN.COR,
              ITEN.TAM,
              SUM(ITEN.QTDE) PED_QTDE,SUM(ITEN.QTDE_F) PED_FAT,
              SUM(RESE.QTDE) RES_QTDE,SUM(RESE.QTDE_B) RES_BAI,
              SUM(PE3.QTDE) EXP_QTDE,SUM(PE3.QTDE_F) EXP_FAT,
              UDF_NVL((SUM(ITEN.QTDE))-UDF_NVL(SUM(RESE.QTDE))-UDF_NVL(SUM(PE3.QTDE))) SALDO
              FROM
              PEDIDO_001 PED
              INNER JOIN (SELECT PEDI.NUMERO, PEDI.CODIGO, PEDI.COR, PEDI.TAM, SUM(PEDI.QTDE) QTDE, SUM(PEDI.QTDE_F) QTDE_F
              FROM PED_ITEN_001 PEDI GROUP BY PEDI.NUMERO, PEDI.CODIGO, PEDI.COR, PEDI.TAM) ITEN
              ON PED.NUMERO=ITEN.NUMERO
                  LEFT JOIN (SELECT RES.NUMERO, RES.CODIGO, RES.COR, RES.TAM, SUM(RES.QTDE) QTDE, SUM(RES.QTDE_B) QTDE_B
                  FROM PED_RESERVA_001 RES GROUP BY RES.NUMERO, RES.CODIGO, RES.COR, RES.TAM) RESE
                  ON ITEN.NUMERO=RESE.NUMERO
                  AND ITEN.CODIGO=RESE.CODIGO
                  AND ITEN.COR=RESE.COR
                  AND ITEN.TAM=RESE.TAM
                      LEFT JOIN (SELECT PED3.NUMERO, PED3.CODIGO, PED3.COR, PED3.TAM, SUM(PED3.QTDE) QTDE, SUM(PED3.QTDE_F) QTDE_F
                      FROM PEDIDO3_001 PED3 GROUP BY PED3.NUMERO, PED3.CODIGO, PED3.COR, PED3.TAM) PE3
                      ON ITEN.NUMERO=PE3.NUMERO
                      AND ITEN.CODIGO=PE3.CODIGO
                      AND ITEN.COR=PE3.COR
                      AND ITEN.TAM=PE3.TAM
                        WHERE PED.NUMERO IN (:PEDIDOS)
                        GROUP BY PED.NUMERO,
                                 ITEN.CODIGO,
                                 ITEN.COR,
                                 ITEN.TAM) 
                            PEDIDO)
                  WHERE SALDO < 0
