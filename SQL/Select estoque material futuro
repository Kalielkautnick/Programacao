-- ESSE SELECT, EU MONTEI PARA O MEU SISTEMA EM DELPHI, ELE RETORNA A QUANTIDADE EM ESTOQUE
//E MOSTRA QUAL VAI SER O ESTOQUE FUTURO, LEVANDO EM CONSIDERAÇÃO OS ITENS EM ABERTO
//EM TODAS AS ORDENS DE COMPRA

SELECT ORDEM, BAIXADO, CODIGO, DESCRICAO, COR, DESC_COR, QUAL, DEPOSITO, ESTOQUE, QTDE_COMPRA, 
        CASE WHEN SALDO_OUTRAS_COMPRAS = 0 AND TOTAL_OUTRAS_COMPRAS > 0 
        THEN TOTAL_OUTRAS_COMPRAS || ' - BAIXADO TOTAL' 
        ELSE TOTAL_OUTRAS_COMPRAS END TOTAL_OUTRAS_COMPRAS, 
        SALDO_OUTRAS_COMPRAS, 
        CASE WHEN BAIXADO = 'N' 
        THEN (ESTOQUE + QTDE_COMPRA + SALDO_OUTRAS_COMPRAS) 
        ELSE (ESTOQUE + SALDO_OUTRAS_COMPRAS) END AS SALDO_FUTURO FROM (
            SELECT V.ID_SEQUENCIA_MAT AS ORDEM, V.BAIXADO, E.ID_MATERIAL AS CODIGO, P.MATERIAL_DESCRICAO AS DESCRICAO, E.COR, C.DESCRICAO AS DESC_COR, 
                    E.QUALIDADE AS QUAL, E.DEPOSITO, E.QUANTIDADE AS ESTOQUE, V.QUANTIDADE AS QTDE_COMPRA,
                    COALESCE((SELECT SUM(I.QUANTIDADE) FROM ITEM_COMPRA I 
                    WHERE I.ID_COMPRA<>V.ID_COMPRA AND I.ID_MATERIAL = E.ID_MATERIAL AND I.COR=E.COR AND I.QUALIDADE=E.QUALIDADE),0) 
                    AS TOTAL_OUTRAS_COMPRAS,
                  
                    COALESCE((SELECT SUM(I.QUANTIDADE) FROM ITEM_COMPRA I 
                    WHERE I.ID_COMPRA<>V.ID_COMPRA AND I.ID_MATERIAL = E.ID_MATERIAL AND I.COR=E.COR AND I.QUALIDADE=E.QUALIDADE
                    AND I.BAIXADO = 'N'),0) AS SALDO_OUTRAS_COMPRAS,
                  
                    0 AS SALDO_FUTURO 
            FROM ESTOQUE_MATERIAL E 
            INNER JOIN MATERIAL P 
            ON (P.ID_MATERIAL=E.ID_MATERIAL) 
            INNER JOIN ITEM_COMPRA V 
            ON (E.ID_MATERIAL=V.ID_MATERIAL) AND (E.COR=V.COR) 
            AND (E.QUALIDADE=V.QUALIDADE) 
            INNER JOIN COR C 
            ON (E.COR=C.COR) 
            WHERE V.ID_COMPRA IN (1) 
            AND E.DEPOSITO = 4 
            ORDER BY V.ID_COMPRA, V.ID_SEQUENCIA_MAT)
