SELECT P.NUMERO, P.CODIGO, P.COR, P.TAM, P.QTDE, P.QTDE_F, P.QTDE_CANC, P.QTDE_ORIG, LOG.DESCRICAO,
SUBSTR(LOG.DESCRICAO,POS_CODIGO, LEN_CODIGO) CODIGO_,
SUBSTR(LOG.DESCRICAO,POS_COR, LEN_COR) COR_,
SUBSTR(LOG.DESCRICAO,POS_TAM, LEN_TAM) TAMANHO_,
SUBSTR(LOG.DESCRICAO,POS_QTDE_ORIG, LEN_QTDE_ORIG) AS QTDE_ANTERIOR_,
CAST(SUBSTR(LOG.DESCRICAO,POS_QTDE_NOVA, LEN_QTDE_NOVA) AS INTEGER) AS QTDE_NOVA_
 FROM PED_ITEN_001 P
INNER JOIN
(
SELECT DESCRICAO, NUMERO, POS_CODIGO, POS_COR, POS_TAM, POS_QTDE_ORIG, POS_QTDE_NOVA, 
INSTR(SUBSTR(DESCRICAO, POS_CODIGO, 100), '''')-1 AS LEN_CODIGO, 
INSTR(SUBSTR(DESCRICAO, POS_COR, 100), '''')-1 AS LEN_COR, 
INSTR(SUBSTR(DESCRICAO, POS_TAM, 100), '''')-1 AS LEN_TAM,
INSTR(SUBSTR(DESCRICAO, POS_QTDE_ORIG, 100), '''')-1 AS LEN_QTDE_ORIG,
INSTR(SUBSTR(DESCRICAO, POS_QTDE_NOVA, 100), '''')-1 AS LEN_QTDE_NOVA
FROM (SELECT max(HORA) HORA, DESCRICAO, CHAVE AS NUMERO, 
INSTR(DESCRICAO, 'CODIGO: ')+9 POS_CODIGO, 
INSTR(DESCRICAO, 'COR: ')+6 POS_COR, 
INSTR(DESCRICAO, 'TAM: ')+6 POS_TAM,
INSTR(DESCRICAO, 'DE: ')+5 POS_QTDE_ORIG,
INSTR(DESCRICAO, 'PARA: ')+7 POS_QTDE_NOVA
FROM LOG WHERE DESCRICAO LIKE '%ALTERAÇÃO DE QUANTIDADE DO PEDIDO%'
GROUP BY DESCRICAO, CHAVE)
) LOG
ON LOG.NUMERO=P.NUMERO AND P.CODIGO = SUBSTR(LOG.DESCRICAO,POS_CODIGO, LEN_CODIGO) AND P.COR = SUBSTR(LOG.DESCRICAO,POS_COR, LEN_COR) AND P.TAM = SUBSTR(LOG.DESCRICAO,POS_TAM, LEN_TAM)
LEFT JOIN (
SELECT N.PEDIDO, N.CODIGO, N.COR, N.TAMANHO, SUM(CASE WHEN NAT.TIPO <> 'D' THEN N.QTDE ELSE N.QTDE * -1 END) AS QTDE_F_CERTA FROM PED_ITEN_001 PED
INNER JOIN NOTAITEN_001 N
ON (N.PEDIDO=PED.NUMERO AND PED.CODIGO=N.CODIGO AND PED.COR=N.COR AND PED.TAM=N.TAMANHO)
LEFT JOIN NATUREZA_001 NAT
ON (NAT.NATUREZA=N.NATUREZA)
GROUP BY N.PEDIDO, N.CODIGO, N.COR, N.TAMANHO
) FAT
ON (FAT.PEDIDO=P.NUMERO AND FAT.CODIGO=P.CODIGO AND FAT.COR=P.COR AND FAT.TAMANHO=P.TAM)
WHERE (P.QTDE+P.QTDE_F+P.QTDE_CANC) <> SUBSTR(LOG.DESCRICAO,POS_QTDE_NOVA, LEN_QTDE_NOVA)
AND P.NUMERO IN ('205918')
