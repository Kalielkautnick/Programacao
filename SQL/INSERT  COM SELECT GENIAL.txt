---ESSE É UM DOS INSERTs MAIS COMPLEXOS JÁ DESENVOLVIDOS, NEM TANTO PELO SQL EM SI, MAS PELA REGRA DE NEGÓCIO COMPLEXA.
---A TABELA VINHA DE INTEGRAÇÃO COM A ESTRUTURA ERRADA, A ESTRUTURA DELA ERA POR GRADE FECHADA (PACK)
---DEPOIS QUE MONTEI ESSE INSERT PRONTO, TODOS OS PEDIDOS PASSARAM A FICAR COM A ESTRUTURA CORRETA.

WITH KITS AS (
    SELECT K.ORDEM,K.NUMERO AS NUM_KIT,
        P.NUMERO,P.CODIGO,P.COR,
        COUNT(*) AS QTDE_ENCONTRADA,
        (
          SELECT COUNT(*) FROM KIT_ITEM_001 KIT
          WHERE KIT.NUMERO = K.NUMERO AND KIT.CODIGO = P.CODIGO AND KIT.COR = P.COR
        ) AS QTDE_TAM
    FROM PED_ITEN_001 P
    INNER JOIN KIT_ITEM_001 K ON K.CODIGO = P.CODIGO AND K.COR = P.COR AND K.TAM = P.TAM
    WHERE P.NUMERO IN ('XXXXX')
    GROUP BY K.ORDEM,K.NUMERO,P.NUMERO,P.CODIGO,P.COR
    HAVING COUNT(*) = (
        SELECT COUNT(*) FROM KIT_ITEM_001 KIT 
        WHERE KIT.NUMERO = K.NUMERO AND KIT.CODIGO = P.CODIGO AND KIT.COR = P.COR
    )
),

BASE_ITENS AS (
    SELECT 
        K.NUMERO AS NUM_KIT, K.ORDEM,K.QTDE AS QTDE_KIT,
        P.NUMERO,P.CODIGO,P.COR,P.TAM,F.POSICAO,P.QTDE,P.QTDE_F,
        RES.QTDE AS RES_QTDE,RES.QTDE_B AS RES_BAI, RES.RESERVA,
        PE3.QTDE AS QTDE_EXP,PE3.QTDE_F AS EXP_FAT
    FROM PED_ITEN_001 P
    INNER JOIN KIT_ITEM_001 K ON K.CODIGO = P.CODIGO AND K.COR = P.COR AND K.TAM = P.TAM
    INNER JOIN PRODUTO_001 PRO ON PRO.CODIGO = P.CODIGO
    LEFT JOIN FAIXA_ITEN_001 F ON F.FAIXA = PRO.FAIXA AND F.TAMANHO = P.TAM
    LEFT JOIN (
        SELECT NUMERO,CODIGO,COR,TAM,MAX(RESERVA) AS RESERVA,SUM(QTDE) AS QTDE,SUM(QTDE_B) AS QTDE_B
        FROM PED_RESERVA_001
        GROUP BY NUMERO, CODIGO, COR, TAM
    ) RES ON P.NUMERO = RES.NUMERO AND P.CODIGO = RES.CODIGO AND P.COR = RES.COR AND P.TAM = RES.TAM
    LEFT JOIN (
        SELECT NUMERO,CODIGO,COR,TAM,SUM(QTDE) AS QTDE,SUM(QTDE_F) AS QTDE_F
        FROM PEDIDO3_001
        GROUP BY NUMERO, CODIGO, COR, TAM
    ) PE3 ON P.NUMERO = PE3.NUMERO AND P.CODIGO = PE3.CODIGO AND P.COR = PE3.COR AND P.TAM = PE3.TAM
    WHERE P.NUMERO IN ('XXXXX')
),

CALCULOS AS (
    SELECT 
        B.*,
        (SELECT MIN(QTDE) FROM (
           SELECT SUM(PED.QTDE + PED.QTDE_F) AS QTDE
           FROM PED_ITEN_001 PED
           WHERE PED.NUMERO = B.NUMERO AND PED.CODIGO = B.CODIGO AND PED.COR = B.COR
           AND PED.TAM IN (SELECT TAM FROM KIT_ITEM_001 WHERE NUMERO = B.NUM_KIT)
           GROUP BY PED.TAM)
        ) AS QTDE_PEDIDO,
        (SELECT MIN(QTDE) FROM (
           SELECT SUM(PED.QTDE + PED.QTDE_F) AS QTDE
           FROM PEDIDO3_001 PED
           WHERE PED.NUMERO = B.NUMERO AND PED.CODIGO = B.CODIGO AND PED.COR = B.COR
           AND PED.TAM IN (SELECT TAM FROM KIT_ITEM_001 WHERE NUMERO = B.NUM_KIT)
           GROUP BY PED.TAM)
        ) AS QTDE_GRADE_EXP,
        (SELECT MIN(QTDE) FROM (
           SELECT SUM(PED.QTDE + PED.QTDE_B) AS QTDE
           FROM PED_RESERVA_001 PED
           WHERE PED.NUMERO = B.NUMERO AND PED.CODIGO = B.CODIGO AND PED.COR = B.COR
           AND PED.TAM IN (SELECT TAM FROM KIT_ITEM_001 WHERE NUMERO = B.NUM_KIT)
           GROUP BY PED.TAM)
        ) AS QTDE_GRADE_RES
    FROM BASE_ITENS B
),

RESULTADO_FINAL AS (
    SELECT C.ORDEM,C.NUMERO,C.CODIGO,C.COR,C.TAM,C.POSICAO,C.QTDE_PEDIDO * C.QTDE_KIT AS QTDE,
        CASE 
	    WHEN C.RES_QTDE IS NULL AND C.QTDE_EXP IS NULL AND C.QTDE_F = 0 THEN 0
        WHEN ((C.RES_QTDE + C.RES_BAI) = (C.QTDE + C.QTDE_F)) OR ((C.QTDE_EXP + C.EXP_FAT) = (C.QTDE + C.QTDE_F)) 
        			AND C.QTDE_GRADE_RES > 0 THEN C.QTDE_GRADE_RES * C.QTDE_KIT		
        WHEN ((C.QTDE_EXP + C.EXP_FAT) < (C.QTDE + C.QTDE_F) AND COALESCE(C.RES_QTDE,0) = 0) THEN C.QTDE_GRADE_EXP * C.QTDE_KIT
		WHEN ((C.RES_QTDE + C.RES_BAI) < (C.QTDE + C.QTDE_F) AND COALESCE(C.QTDE_EXP,0) = 0) THEN C.QTDE_GRADE_RES * C.QTDE_KIT
		ELSE 0 END AS QTDE_B,
        C.RESERVA
    FROM CALCULOS C
    WHERE C.QTDE_PEDIDO > 0
)

INSERT INTO INF_PED_ITEN_001 (ORDEM, NUMERO, CODIGO, COR, TAM, QTDE, QTDE_B, RESERVA)
SELECT R.ORDEM, R.NUMERO, R.CODIGO, R.COR, R.TAM, R.QTDE, R.QTDE_B, R.RESERVA
FROM RESULTADO_FINAL R
INNER JOIN KITS K ON R.NUMERO = K.NUMERO AND R.ORDEM  = K.ORDEM AND R.CODIGO = K.CODIGO AND R.COR = K.COR
ORDER BY 2,3,4,1,R.POSICAO;

