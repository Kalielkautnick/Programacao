--- INSERT ABSURDO NA TABELA DE FAIXA DE TAMANHOS, ORDENANDO TODOS OS TAMANHOS POSSÍVEIS TAL COMO NA VIDA REAL
--- RESOLVEMOS ESSE PROBLEMA COM UMA ORDEM DE PRIORIDADE E CATEGORIAS, TAMANHOS APENAS COM LETRAS, APENAS COM NÚMEROS, COM +2 NÚMEROS E ALGUM CARACTER JUNTO, ETC.
--- DESSA FORMA CONSEGUIMOS FAZER UM ORDENADOR INTELIGENTE E OS TAMANHOS FICAM ORDENADOS COM ESTRUTURA CONDICIONAL.

WITH TAMANHOS AS (
SELECT TAM, CAST(TAM AS INTEGER) TAM_TRATADO, CAST(TAM AS INTEGER) TAM_TRATADO2, 1 PRIORIDADE FROM TABTAM_001 WHERE REGEXP_REPLACE(TAM, '\D', '', 'g') = TAM
UNION ALL
SELECT TAM, CAST(SPLIT_PART(LTRIM(REGEXP_REPLACE(TAM, '\D', '-', 'g'),'-'),'-',1) AS INTEGER) TAM_TRATADO,
CAST(REVERSE(SPLIT_PART(LTRIM(REGEXP_REPLACE(REVERSE(TAM), '\D', '-', 'g'),'-'),'-',1)) AS INTEGER) TAM_TRATADO2,
2 PRIORIDADE FROM TABTAM_001 WHERE REGEXP_REPLACE(TAM, '\D', '', 'g') <> TAM AND LENGTH(REGEXP_REPLACE(TAM, '\D', '', 'g')) >= 2
UNION ALL
SELECT TAM, 9999 TAM_TRATADO, 9999 TAM_TRATADO2, 3 PRIORIDADE FROM 
TABTAM_001 WHERE REGEXP_REPLACE(TAM, '\D', '', 'g') <> TAM AND LENGTH(REGEXP_REPLACE(TAM, '\D', '', 'g')) = 1
UNION ALL
SELECT TAM, 9999 TAM_TRATADO, 9999+((LENGTH(TAM)*CASE WHEN TAM LIKE 'P%' THEN -1 ELSE 1 END)) TAM_TRATADO2, 4 PRIORIDADE FROM 
TABTAM_001 WHERE REGEXP_REPLACE(TAM, '\D', '', 'g') <> TAM AND LENGTH(REGEXP_REPLACE(TAM, '\D', '', 'g')) = 0
), LISTA AS (
SELECT DISTINCT LISTA FROM (
SELECT STRING_AGG(DISTINCT T1.TAM, '/' ORDER BY T1.TAM) LISTA, CODIGO
FROM PA_ITEN_001 T1
GROUP BY CODIGO))

INSERT INTO FAIXA_ITEN_001 (FAIXA, PERCENTUAL, TAMANHO, POSICAO)
SELECT LPAD(FAIXA::TEXT, 3, '0') FAIXA, 0 PERCENTUAL, H.TAM TAMANHO, 
ROW_NUMBER () OVER (PARTITION BY LPAD(FAIXA::TEXT, 3, '0') 
ORDER BY H.FAIXA,
CASE WHEN O.TAM LIKE 'U%' THEN 1 ELSE 2 END,
O.TAM_TRATADO, 
CASE WHEN O.PRIORIDADE IN (1,2) THEN O.TAM_TRATADO2 ELSE 9999 END, 
CASE WHEN O.TAM LIKE 'P%' THEN O.TAM_TRATADO2+1000 
WHEN O.TAM LIKE 'M%' THEN O.TAM_TRATADO2+1200 WHEN O.TAM LIKE 'G%' AND O.PRIORIDADE = 4 THEN O.TAM_TRATADO2+1500
WHEN O.TAM LIKE 'G%' THEN O.TAM_TRATADO2+1600 WHEN O.TAM LIKE 'E%' THEN O.TAM_TRATADO2+1700 
WHEN O.TAM LIKE 'X%' THEN O.TAM_TRATADO2+1800 END ASC, O.TAM) AS POSICAO FROM (
SELECT DISTINCT
ROW_NUMBER () OVER (PARTITION BY 1 ORDER BY 1) + COALESCE((SELECT MAX(CAST(FAIXA AS INTEGER)) FROM FAIXA_ITEN_001),0) AS FAIXA,
UNNEST(STRING_TO_ARRAY(LISTA, '/')) TAM FROM LISTA L
WHERE NOT EXISTS (
SELECT Y2.LISTA FROM (
SELECT STRING_AGG(FX.TAMANHO, '/' ORDER BY FX.TAMANHO) AS LISTA, FX.FAIXA FROM FAIXA_ITEN_001 FX 
GROUP BY FX.FAIXA) Y2
WHERE Y2.LISTA=L.LISTA)
) H 
INNER JOIN TAMANHOS O ON O.TAM=H.TAM
