INSERT INTO INF_PED_ITEN (ORDEM, NUMERO, CODIGO, COR, TAM, QTDE, QTDE_B)
SELECT TAB_CERTA.* FROM (
     SELECT ORDEM, NUM_KIT, NUMERO, CODIGO, COR, QTDE_TAM FROM
     (SELECT K.ORDEM, K.NUMERO AS NUM_KIT, P.NUMERO, P.CODIGO, P.COR,
             (SELECT COUNT(*) FROM KIT_ITEM_001 KIT WHERE KIT.NUMERO=K.NUMERO AND KIT.CODIGO=P.CODIGO AND KIT.COR=P.COR) AS QTDE_TAM
             FROM PED_ITEN_001 P
      INNER JOIN KIT_ITEM_001 K 
      ON (K.CODIGO = P.CODIGO)
      AND (K.COR=P.COR)
      AND (K.TAM=P.TAM)
           WHERE P.NUMERO = '02702'
     ) TAB
GROUP BY ORDEM, NUM_KIT, NUMERO, CODIGO, COR, QTDE_TAM
HAVING COUNT(*) = QTDE_TAM
) TAB4
INNER JOIN (SELECT ORDEM, NUMERO, CODIGO, COR, TAM, QTDE_GRADE * QTDE_KIT AS QTDE,
       CASE
           WHEN COALESCE(RES_QTDE, '-') = '-'
                AND COALESCE(QTDE_EXP, '-') = '-'
                AND QTDE_F = 0 THEN 0
           WHEN ((RES_QTDE + RES_BAI) = (QTDE + QTDE_F)) OR ((QTDE_EXP + EXP_FAT) = (QTDE + QTDE_F)) THEN QTDE_GRADE * QTDE_KIT
         WHEN ((QTDE_EXP + EXP_FAT) < (QTDE + QTDE_F) AND UDF_NVL(RES_QTDE) = 0) THEN QTDE_GRADE_EXP * QTDE_KIT
WHEN ((RES_QTDE + RES_BAI) < (QTDE + QTDE_F) AND UDF_NVL(QTDE_EXP) = 0) THEN QTDE_GRADE_RES * QTDE_KIT
ELSE 0
END AS QTDE_B,
COALESCE(NUM_RESERVA, '9999') AS RESERVA
FROM
  (SELECT NUM_KIT, NUMERO, CODIGO, COR, TAM, QTDE, QTDE_F, RES_QTDE, RES_BAI,
      (SELECT MIN(R.QTDE)+MIN(R.QTDE_B)
      FROM PED_RESERVA_001 R
      WHERE R.NUMERO = TAB.NUMERO
        AND R.CODIGO=TAB.CODIGO
        AND R.COR=TAB.COR
        AND R.TAM IN (SELECT DISTINCT KIT.TAM FROM KIT_ITEM_001 KIT WHERE KIT.NUMERO = TAB.NUM_KIT)
                    ) AS QTDE_GRADE_RES,
      (SELECT FIRST 1 R.RESERVA
      FROM PED_RESERVA_001 R
      WHERE R.NUMERO = TAB.NUMERO
        AND R.CODIGO=TAB.CODIGO
        AND R.COR=TAB.COR
        AND R.TAM IN (SELECT DISTINCT KIT.TAM FROM KIT_ITEM_001 KIT WHERE KIT.NUMERO = TAB.NUM_KIT)
                    ) AS NUM_RESERVA,

          QTDE_EXP,
          EXP_FAT,
          (SELECT MIN(P3.QTDE_F)+MIN(P3.QTDE)
      FROM PEDIDO3_001 P3
      WHERE P3.NUMERO = TAB.NUMERO
        AND P3.CODIGO=TAB.CODIGO
        AND P3.COR=TAB.COR
        AND P3.TAM IN (SELECT DISTINCT KIT.TAM FROM KIT_ITEM_001 KIT WHERE KIT.NUMERO = TAB.NUM_KIT)
                    ) AS QTDE_GRADE_EXP,


     (SELECT MIN(PED.QTDE_F)+MIN(PED.QTDE)
      FROM PED_ITEN_001 PED
      WHERE PED.NUMERO = TAB.NUMERO
        AND PED.CODIGO=TAB.CODIGO
        AND PED.COR=TAB.COR
        AND PED.TAM IN (SELECT DISTINCT KIT.TAM FROM KIT_ITEM_001 KIT WHERE KIT.NUMERO = TAB.NUM_KIT)
                    ) AS QTDE_GRADE,
          ORDEM,
          QTDE_KIT
   FROM
     (SELECT K.NUMERO AS NUM_KIT,
             P.NUMERO,
             P.CODIGO,
             P.COR,
             P.TAM,
             P.QTDE,
             P.QTDE_F,
             K.ORDEM,
             K.QTDE AS QTDE_KIT,
             RES.QTDE AS RES_QTDE,
             RES.QTDE_B AS RES_BAI,
             PE3.QTDE AS QTDE_EXP,
             PE3.QTDE_F AS EXP_FAT
      FROM PED_ITEN_001 P
      INNER JOIN KIT_ITEM_001 K 
      ON (K.CODIGO = P.CODIGO)
      AND (K.COR=P.COR)
      AND (K.TAM=P.TAM)
      LEFT JOIN
        (SELECT RES.NUMERO,
                RES.CODIGO,
                RES.COR,
                RES.TAM,
                SUM(RES.QTDE) QTDE,
                SUM(RES.QTDE_B) QTDE_B
         FROM PED_RESERVA_001 RES
         GROUP BY RES.NUMERO,
                  RES.CODIGO,
                  RES.COR,
                  RES.TAM) RES ON P.NUMERO=RES.NUMERO
      AND P.CODIGO=RES.CODIGO
      AND P.COR=RES.COR
      AND P.TAM=RES.TAM
      LEFT JOIN
        (SELECT PED3.NUMERO,
                PED3.CODIGO,
                PED3.COR,
                PED3.TAM,
                SUM(PED3.QTDE) QTDE,
                SUM(PED3.QTDE_F) QTDE_F
         FROM PEDIDO3_001 PED3
         GROUP BY PED3.NUMERO,
                  PED3.CODIGO,
                  PED3.COR,
                  PED3.TAM) PE3 
      ON P.NUMERO=PE3.NUMERO
      AND P.CODIGO=PE3.CODIGO
      AND P.COR=PE3.COR
      AND P.TAM=PE3.TAM
      WHERE P.NUMERO = '02702'
      ORDER BY 
               P.CODIGO,
               P.COR,
               K.ORDEM) TAB
) TAB2
WHERE QTDE_GRADE > 0) TAB_CERTA
ON (TAB_CERTA.NUMERO=TAB4.NUMERO) AND (TAB_CERTA.ORDEM = TAB4.ORDEM) AND (TAB_CERTA.CODIGO = TAB4.CODIGO) AND (TAB_CERTA.COR = TAB4.COR)
ORDER BY NUMERO, CODIGO, COR, ORDEM
