--ESSE SQL EU MONTEI QUANDO PRECISAVAMOS TIRAR UM RELATÓRIO DE MOVIMENTAÇÃO DE ESTOQUE DE PRODUTO QUE UM CLIENTE PEDIU

SELECT DEPOSITO, CODIGO, COR, TAMANHO, TIPO, LOTE, LOCAL, QUANTIDADE_ESTOQUE, QTDE_MOV, PRIMEIRA_MOV, ULTIMA_MOV, 
        QTDE_PRIMEIRA_ENTRADA, ULTIMA_ENTRADA, ULTIMA_SAIDA FROM (
SELECT PAMOV.DEPOSITO, 
       PAMOV.CODIGO, 
       PAMOV.COR, 
       PAMOV.TAMANHO, 
       PAMOV.TIPO, 
       PAMOV.LOTE, 
       PAMOV.LOCAL, 
       PA.QUANTIDADE AS QUANTIDADE_ESTOQUE,
       SUM(CASE WHEN PAMOV.OPERACAO = 'E' THEN PAMOV.QTDE ELSE (PAMOV.QTDE * -1) END) AS QTDE_MOV,

      (SELECT MIN(P.DT_MVTO) FROM PA_MOV_001 P
      WHERE P.DEPOSITO=PAMOV.DEPOSITO AND P.LOTE=PAMOV.LOTE AND P.LOCAL=PAMOV.LOCAL AND 
      P.CODIGO=PAMOV.CODIGO AND P.COR=PAMOV.COR AND P.TAMANHO=PAMOV.TAMANHO AND P.TIPO=PAMOV.TIPO) AS PRIMEIRA_MOV,

      (SELECT FIRST 1(P.QTDE) FROM PA_MOV_001 P
      WHERE P.DEPOSITO=PAMOV.DEPOSITO AND P.LOTE=PAMOV.LOTE AND P.LOCAL=PAMOV.LOCAL AND 
      P.CODIGO=PAMOV.CODIGO AND P.COR=PAMOV.COR AND P.TAMANHO=PAMOV.TAMANHO AND P.TIPO=PAMOV.TIPO 
      AND P.OPERACAO = 'E' 
      ORDER BY P.DT_MVTO) AS QTDE_PRIMEIRA_ENTRADA,

      (SELECT MAX(P.DT_MVTO) FROM PA_MOV_001 P
      WHERE P.DEPOSITO=PAMOV.DEPOSITO AND P.LOTE=PAMOV.LOTE AND P.LOCAL=PAMOV.LOCAL AND 
      P.CODIGO=PAMOV.CODIGO AND P.COR=PAMOV.COR AND P.TAMANHO=PAMOV.TAMANHO AND P.TIPO=PAMOV.TIPO 
      AND P.OPERACAO = 'E') AS ULTIMA_ENTRADA,
      
      (SELECT MAX(P.DT_MVTO) FROM PA_MOV_001 P
      WHERE P.DEPOSITO=PAMOV.DEPOSITO AND P.LOTE=PAMOV.LOTE AND P.LOCAL=PAMOV.LOCAL AND 
      P.CODIGO=PAMOV.CODIGO AND P.COR=PAMOV.COR AND P.TAMANHO=PAMOV.TAMANHO AND P.TIPO=PAMOV.TIPO 
      AND P.OPERACAO = 'S') AS ULTIMA_SAIDA
FROM PA_MOV_001 PAMOV
INNER JOIN PA_ITEN_001 PA
ON  (PAMOV.CODIGO = PA.CODIGO) AND (PAMOV.COR = PA.COR) AND (PAMOV.TAMANHO = PA.TAM) AND 
    (PAMOV.DEPOSITO = PA.DEPOSITO) AND (PAMOV.TIPO = PA.TIPO) AND (PAMOV.LOTE = PA.LOTE) AND (PAMOV.LOCAL = PA.LOCAL)
WHERE 1 > 0
AND PAMOV.CODIGO IN (:PRO)
AND PAMOV.COR IN (:COR)
GROUP BY PAMOV.DEPOSITO, PAMOV.CODIGO, PAMOV.COR, PAMOV.TAMANHO, PAMOV.TIPO, PAMOV.LOTE, PAMOV.LOCAL, PA.QUANTIDADE)
WHERE 1 > 0
