---ESSE SELECT EU MONTEI PARA FACILITAR NOSSO ATENDIMENTO E PODERMOS COMPARAR DE FORMA FÁCIL OS ITENS DE UM PEDIDO E O SALDO EM ESTOQUE DELES,
--- MOSTRANDO O TOTAL EM RESERVA, EM EXPEDIÇÃO E ESTOQUE.

SELECT DEPOSITO, LOTE, LOCAL, CODIGO, TAM, QUAL, ESTOQUE, QTDE_PEND_PED, TOTAL_EM_RESERVA, TOTAL_EM_EXP, DISPONIVEL, PERC_ATENDIDO, ATENDE_TOTAL FROM(
SELECT DEPOSITO, 
       LOTE, 
       LOCAL, 
       CODIGO, 
       COR, 
       TAM, 
       QUAL, 
       ESTOQUE, 
       QTDE_PEND_PED, 
       TOTAL_EM_RESERVA, 
       TOTAL_EM_EXP, 
       DISPONIVEL, 
          CASE WHEN DISPONIVEL >= 0 THEN 100 || '%'
          ELSE (CAST((ESTOQUE * 100) / (QTDE_PEND_PED + TOTAL_EM_RESERVA + TOTAL_EM_EXP) AS NUMERIC(13,2))) || '%' END AS PERC_ATENDIDO,
          
          CASE WHEN DISPONIVEL >= 0 THEN 'S' 
          ELSE 'N' END AS ATENDE_TOTAL
          FROM (
                SELECT
                PA.DEPOSITO,
                PA.LOTE,
                PA.LOCAL,
                P.CODIGO,
                P.COR,
                P.TAM,
                PA.TIPO AS QUAL,
                PA.QUANTIDADE AS ESTOQUE,
                COALESCE((SELECT SUM(PED.QTDE) FROM PED_ITEN_001 PED WHERE PED.NUMERO=P.NUMERO AND PED.CODIGO=P.CODIGO 
                          AND PED.COR=P.COR AND PED.TAM=P.TAM AND PED.QUALIDADE=P.QUALIDADE),0) AS QTDE_PEND_PED,
                          
                COALESCE((SELECT SUM(RES.QTDE) FROM PED_RESERVA_001 RES WHERE RES.CODIGO=P.CODIGO AND RES.COR=P.COR 
                          AND RES.TAM=P.TAM AND RES.TIPO=P.QUALIDADE),0) AS TOTAL_EM_RESERVA,
                          
                COALESCE((SELECT SUM(EXP.QTDE) FROM PEDIDO3_001 EXP WHERE EXP.CODIGO=P.CODIGO AND EXP.COR=P.COR 
                          AND EXP.TAM=P.TAM AND EXP.QUALIDADE=P.QUALIDADE),0) AS TOTAL_EM_EXP,

                COALESCE(PA.QUANTIDADE - (P.QTDE + 
                COALESCE((SELECT SUM(RES.QTDE) FROM PED_RESERVA_001 RES 
                          WHERE RES.CODIGO=P.CODIGO AND RES.COR=P.COR AND RES.TAM=P.TAM AND RES.TIPO=P.QUALIDADE),0) + 
                          COALESCE((SELECT SUM(EXP.QTDE) FROM PEDIDO3_001 EXP 
                          WHERE EXP.CODIGO=P.CODIGO AND EXP.COR=P.COR AND EXP.TAM=P.TAM AND EXP.QUALIDADE=P.QUALIDADE),0)),0) AS DISPONIVEL,

                0 AS PERC_ATENDIDO,
                'N' AS ATENDE_TOTAL
                FROM PED_ITEN_001 P
                LEFT JOIN PA_ITEN_001 PA
                ON (P.CODIGO=PA.CODIGO) AND (P.COR=PA.COR) AND (P.TAM=PA.TAM) AND (P.QUALIDADE=PA.TIPO)
                WHERE P.NUMERO IN ('31377','31375')
                AND PA.DEPOSITO = '0005'
                ORDER BY P.NUMERO, P.CODIGO, P.COR, PA.TIPO
        )
)

